<p-toast position="top-right" />
<section class="welcome full-width p-[1rem] md:p-4">
  <div class="w-full py-3 flex items-center justify-between">
    <h1 class="text-xl font-medium tracking-normal leading-[1.3]">Медиа файлы</h1>
    <div class="flex justify-end gap-2">
      <app-sort-menu (sortChange)="onSortChange($event)" class="hidden md:block"></app-sort-menu>
      <app-grid-settings
        class="hidden md:block"
        (gridSizeChange)="onGridSizeChange($event)"
        (showFilenameChange)="onShowFilenameChange($event)"
      >
      </app-grid-settings>
      @if (isPublished()) {
        <button
          type="button"
          class="flex items-center gap-1 px-3 py-1.5 text-[#16a34a] hover:text-[#15803d] border border-[#16a34a] hover:border-[#15803d] rounded-md transition"
          (click)="copyPublicLink()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M13.828 10.172a4 4 0 010 5.656l-2 2a4 4 0 11-5.656-5.656l1-1"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.172 13.828a4 4 0 010-5.656l2-2a4 4 0 115.656 5.656l-1 1"
            />
          </svg>
          <span class="text-sm md:text-base">Скопировать публичную ссылку</span>
        </button>
      }
      <div
        (click)="showUploadModal.set(true)"
        class="flex items-center gap-1 px-3 py-1.5 cursor-pointer text-[#1ac2c4] relative"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="border border-[#1ac2c4] rounded-full w-4 h-4 max-[767px]:w-[14px] max-[767px]:h-[14px]"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M12 5v14M5 12h14" />
        </svg>
        <span
          class="text-sm font-medium tracking-normal leading-[1] md:text-base md:font-normal md:leading-normal"
          >Добавить медиа</span
        >
      </div>
    </div>
  </div>

  <app-file-grid
    [files]="files()"
    [gridSize]="gridSize()"
    [showFilename]="showFilename()"
    [showEmptyState]="showEmptyState()"
    [menuOptions]="menuOptions()"
    (cardClick)="openViewer($event.index)"
    (filesDropped)="processFiles($event)"
    (fileSelected)="handleFileSelect($event)"
    (imageError)="handleImageError($event.event, $event.file)"
    class="w-full h-[-webkit-fill-available]"
  ></app-file-grid>

  @if (uploadStats.totalFiles() > 0 && showStatus()) {
    <div class="upload-status">
      <div class="upload-info">
        <div class="upload-header">
          <div class="upload-text">
            @if (!uploadStats.allFilesUploaded()) {
              Загрузка {{ uploadStats.uploadedFiles() }} из {{ uploadStats.totalFiles() }} файлов
            } @else {
              Все загрузки завершены
            }
          </div>
          <button class="close-button" (click)="closeStatus()">
            <svg
              width="14"
              height="14"
              viewBox="0 0 14 14"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M13 1L1 13M1 1L13 13"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
        @if (!uploadStats.allFilesUploaded()) {
          <div class="upload-stats">
            {{ uploadStats.formatBytes(uploadStats.uploadedSize()) }} /
            {{ uploadStats.formatBytes(uploadStats.totalSize()) }} •
            {{ uploadStats.formatBytes(uploadStats.uploadSpeed()) }}/s
          </div>
        } @else {
          <div class="upload-stats">Вы можете безопасно закрыть эту панель</div>
        }
      </div>
      <div class="progress-container">
        <div
          class="progress-bar"
          [style.width.%]="
            uploadStats.totalSize() > 0
              ? (uploadStats.uploadedSize() / uploadStats.totalSize()) * 100
              : (uploadStats.uploadedFiles() / Math.max(uploadStats.totalFiles(), 1)) * 100
          "
        ></div>
      </div>
    </div>
  }
</section>

@if (showUploadModal()) {
  <app-upload-modal
    (fileSelected)="onModalFileSelected($event)"
    (close)="showUploadModal.set(false)"
  ></app-upload-modal>
}

@if (notification().visible) {
  <div
    class="fixed bottom-4 right-4 bg-black bg-opacity-70 text-white text-[14px] p-4 shadow-lg z-50"
    style="min-width: 150px; text-align: center"
  >
    <div>{{ notification().message }}</div>
  </div>
}

<p-galleria
  [value]="files()"
  [(visible)]="viewerVisible"
  [(activeIndex)]="viewerIndex"
  [fullScreen]="true"
  [circular]="true"
  [showThumbnails]="true"
  [showItemNavigators]="true"
  [showItemNavigatorsOnHover]="true"
  [numVisible]="5"
  [baseZIndex]="10000"
>
  <ng-template pTemplate="item" let-file>
    <img [src]="file['originalUrl'] ?? file.previewUrl" class="public-galleria" alt="" />
  </ng-template>

  <ng-template pTemplate="thumbnail" let-file>
    <img [src]="file.previewUrl" class="w-full h-full object-cover" alt="" />
  </ng-template>
</p-galleria>

<!-- наш крестик поверх (если встроенный не работает/не нужен) -->
@if (viewerVisible) {
  <button
    type="button"
    class="fixed top-3 right-3 z-[10001] w-10 h-10 rounded-full bg-black/60 text-white flex items-center justify-center hover:bg-black/70 transition"
    aria-label="Закрыть"
    (click)="viewerVisible = false"
  >
    ✕
  </button>
}
