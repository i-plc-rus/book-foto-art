<app-gallery-layout>
  @if (errorMessage) {
    <div class="error">{{ errorMessage }}</div>
  } @else {
    @if (!isGalleryEmpty() && !isCreatingNewCollection()) {
      <div class="collection-top">
        <app-collection-header
          [searchTerm]="searchTerm()"
          (searchTermChange)="searchTerm.set($event)"
          [sort]="sortOption()"
          (newCollection)="handleNewCollection()"
        />

        <div class="hidden md:flex justify-between items-center mb-[1rem] md:mt-0">
          <div class="collection-top__filter">
            <app-filter-dropdown [config]="STATUS" [disabled]="true" />
            <app-filter-dropdown [config]="CATEGORY_TAG" [disabled]="true" />

            <app-filter-date [config]="EVENT_DATE" (onSelect)="onSelectDate($event)" />
            <app-filter-dropdown [config]="EXPIRY_DATE" [disabled]="true" />
            <app-filter-dropdown [config]="STARRED" [disabled]="true" />
          </div>

          <div class="collection-top__filter">
            <app-sort-dropdown [sort]="sortOption()" (sortChange)="onSortChange($event)" />
            <app-collection-view [view]="displayView()" (chooseView)="changeDisplayView($event)" />
          </div>
        </div>
      </div>

      <ng-container [ngTemplateOutlet]="view"></ng-container>
    } @else {
      <ng-container [ngTemplateOutlet]="steps"></ng-container>
    }
  }
</app-gallery-layout>

<ng-template #steps>
  <!-- Шаг 1 -->
  @if (currentStep() === 1) {
    <section class="welcome centered mt-5 md:mt-0">
      <p class="subtitle">Начало работы</p>
      <h1 class="headline">Опубликовать свою первую галерею всего за 3 шага</h1>
      <button class="upload-button" (click)="nextStep()">Загрузить фото</button>
      <div class="promo-image">
        <img src="assets/icons/promo.png" alt="Promo Image" />
      </div>
    </section>
  } @else {
    <section class="welcome centered">
      <p class="subtitle">Шаг 2 из 3</p>

      @if (isLoading) {
        <div class="loading-message">Создаём коллекцию...</div>
      }
      <h1
        class="headline text-[1.2rem] font-medium mb-4 leading-[1.2] tracking-[0.02em] text-[#111] md:text-[1.8rem] md:mb-6"
      >
        Введите наименование коллекции
      </h1>
      <form class="step2-form" [formGroup]="formStep2">
        <div class="form-group">
          <label for="galleryName">Имя коллекции</label>
          <input
            id="galleryName"
            pInputText
            type="text"
            placeholder="например: Псков - Свадьба"
            formControlName="name"
            name="galleryName"
            autocomplete="off"
            [disabled]="isSubmitting() || isLoading"
          />
          @if (formStep2.controls.name.touched && formStep2.controls.name.invalid) {
            @if (formStep2.controls.name.errors?.['required']) {
              <div class="error-text">Укажите название.</div>
            }
            @if (formStep2.controls.name.errors?.['maxlength']) {
              <div class="error-text">Слишком длинное название.</div>
            }
          }
        </div>

        <div class="form-group">
          <label for="galleryDate">Дата события</label>
          <p-datepicker
            styleClass="calendar-collection"
            [disabled]="isSubmitting() || isLoading"
            name="galleryDate"
            formControlName="date"
          ></p-datepicker>
          @if (formStep2.controls.date.touched && formStep2.controls.date.invalid) {
            @if (formStep2.controls.date.errors?.['required']) {
              <div class="error-text">Укажите дату события.</div>
            }
          }
        </div>

        <button class="submit-btn" (click)="nextStep()" [disabled]="step2Invalid">
          Создать коллекцию
        </button>
      </form>
    </section>
  }
</ng-template>

<ng-template #gridView>
  <div class="file-grid grid-small">
    @for (item of filteredCollections(); track $index) {
      <app-collection-card
        [collection]="item"
        (action)="onActionClick($event)"
        (navigate)="onNavigate($event)"
      />
    }
  </div>
</ng-template>

<ng-template #tableView>
  <app-collection-table [collections]="filteredCollections()" (action)="onActionClick($event)" />
</ng-template>

<ng-template #emptyView>
  <div class="empty-container">
    <img class="cover-image" src="assets/icons/empty.svg" alt="Пусто" />
    <p>Ничего не найдено</p>
    <button (click)="handleNewCollection()" class="create-button">Создать первую коллекцию</button>
  </div>
</ng-template>

<ng-template #view>
  @if (filteredCollections().length === 0) {
    <ng-container [ngTemplateOutlet]="emptyView"></ng-container>
  } @else {
    @if (displayView() === 'grid') {
      <ng-container [ngTemplateOutlet]="gridView"></ng-container>
    } @else {
      <ng-container [ngTemplateOutlet]="tableView"></ng-container>
    }
  }
</ng-template>
